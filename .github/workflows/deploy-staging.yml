name: Deploy to Staging

on:
  push:
    branches:
      - main

jobs:
  deploy:
    # Do not deploy in the main repository, only in user projects
    if: github.repository_owner != 'fastapi'
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: staging
      # Provide safe defaults so GitHub-hosted runners don't fail when secrets aren't set.
      DOMAIN: ${{ secrets.DOMAIN_STAGING || 'example.com' }}
      STACK_NAME: ${{ secrets.STACK_NAME_STAGING || 'ai-pic-staging' }}
      DOCKER_IMAGE_BACKEND: ${{ secrets.DOCKER_IMAGE_BACKEND || 'backend' }}
      SECRET_KEY: ${{ secrets.SECRET_KEY || 'dev-secret' }}
      POSTGRES_USER: ${{ secrets.POSTGRES_USER || 'postgres' }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD || 'postgres' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Compose config
        run: docker compose -f docker-compose.yml config > /dev/null
      - name: Build images
        run: docker compose -f docker-compose.yml build
